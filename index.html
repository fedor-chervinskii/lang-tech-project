<!DOCTYPE html>
<meta charset="utf-8">
  <style>

    path {
      fill: none;
      stroke: #000;
      fill:#f7f7f7;
      stroke-linejoin: round;
      stroke-linecap: round;
      stroke-width: .5px;
    }

    .bubble {
      fill-opacity: .5;
      stroke: #000000;
      fill:#000000;
      stroke-width: .1px;
    }

    .redBubble {
      fill-opacity: .5;
      stroke: #ff0000;
      fill:#ff0000;
      stroke-width: .5px;
    }

    </style>
  <body>

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="point-in-polygon.js"></script>
    <script>

      var width = 1300,
          height = 600;
      tweetBubbleRaius = 5;

      var color = d3.scale.threshold()
                  .domain([-1.0, -0.8, -0.6, -0.4, -0.2, 0.0,.2, .4, .6, .8, 1.0])
                  .range(["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"]);

      var projection = d3.geo.mercator()
      .rotate([-10.7,4.2,-6.3])
      //.rotate([0,0,0])
      .center([38.4, 55.8])
      .scale(20000)
      .translate([width / 2, height / 2]);

      var path = d3.geo.path()
      .projection(projection);

      var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

      d3.json("mo.geojson", function(error, moscow) {
              if (error) return console.error(error);

              regionsGroup = svg.append("g");

              regionsGroup
              .selectAll("path")
              .data(moscow.features)
              .enter().append("path")
              .attr("class", "region")
              .attr("d", path);

              //Group of tweets locations
              bubbleGroup = svg.append("g").attr("class", "bubble");
              addRedBubble();
              addZoom();

              setInterval(function () {

                d3.json("tweets.json", function(error, tweets) {

                  var projectedLocations = [];

                  for (var i=0; i<tweets.length; i++) {

                    var tweet = tweets[i];
                    var lat = Math.floor(tweets[i]["location"][0]*1000+0.5)/1000;
                    var long = Math.floor(tweets[i]["location"][1]*1000+0.5)/1000;
                    projectedLocations[i] = projection([lat,long]);

                    updateRegionsWithTweet(tweet)

                  }

                  addTweetBubbles(projectedLocations);

                });

              }, 3000);

              });

addTweetBubbles = function (projectedLocations) {
    bubbleGroup.
    selectAll("circle")
    .data(projectedLocations)
    .enter().append("circle")
    .attr("transform", function(d) {
      console.log(d);
      return "translate(" + d + ")";})
    .attr("r", 5/zoom.scale());
}

updateRegionsWithTweet = function (tweet) {
  regionsGroup
  .selectAll(".region")
  .style("fill", function(d) {

    var score = Math.random();
    if (score < 0.5)
      score = - score;

    for (var polygon = 0; polygon < d.geometry.coordinates.length; polygon++)
      if (pointInPolygon(tweet["location"], d.geometry.coordinates[polygon]))
        return color(score);
      else
        return "#f7f7f7";

  });

}

addRedBubble = function() {
  redBubbleGroup = svg.append("g");

  redBubbleGroup.attr("class", "redBubble")
  .selectAll("circle")
  .data([projection([37.6178, 55.7517])])
  .enter().append("circle")
  .attr("transform", function(d) {
    return "translate(" + d + ")"; })
  .attr("r", 5);

}

addZoom = function() {

  zoom = d3.behavior.zoom()
      .on("zoom",function() {
        regionsGroup.attr("transform","translate("+
              d3.event.translate.join(",")+")scale("+d3.event.scale+")");

        redBubbleGroup.attr("transform","translate("+
              d3.event.translate.join(",")+")scale("+d3.event.scale+")");
        redBubbleGroup.selectAll("circle").attr("r", function() {
          return 5/d3.event.scale; })
        bubbleGroup.attr("transform","translate("+
              d3.event.translate.join(",")+")scale("+d3.event.scale+")");
        bubbleGroup.selectAll("circle").attr("r", function() {
                return 5/d3.event.scale; })
        regionsGroup.selectAll("path")
            .attr("d", path.projection(projection));

          });

  svg.call(zoom)
}

</script>
